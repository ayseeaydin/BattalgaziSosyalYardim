@model BattalgaziSosyalYardim.Models.ApplicationCreateViewModel

@{
    // Bu satırlar sorun çıkarıyorsa geçici olarak kaldırabilirsin,
    // ama normalde bu layout ile çalışıyoruz.
    Layout = "~/Views/Shared/_Bootstrap5Layout.cshtml";
    ViewData["Title"] = "Başvuru Formu";
}

@section Styles {
    <style>
        body {
            background: url('/thema/img/belediye.jpg') no-repeat center center fixed;
            background-size: cover
        }

        .background-overlay {
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            filter: brightness(.7);
            z-index: -1
        }

        .custom-card {
            background-color: rgba(255,255,255,.95);
            border-radius: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,.2)
        }

        .form-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border-bottom: 1px solid #ddd
        }

            .form-header img {
                height: 60px
            }

            .form-header h2 {
                flex-grow: 1;
                text-align: center;
                margin: 0;
                font-size: 1.5rem;
                font-weight: bold;
                color: #333
            }

        .admin-login {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1000;
            background-color: azure;
            color: #000
        }

        .req::after {
            content: " *";
            color: #d00;
            font-weight: 700
        }
    </style>
}

<a href="/Login/Login" class="btn btn-outline-light admin-login" title="Yönetici Girişi">👤 Yönetici Girişi</a>
<div class="background-overlay"></div>

<div class="container mt-5 mb-5">
    <div class="card custom-card">
        <div class="form-header">
            <img src="/thema/img/logo.png" alt="Logo" />
            <h2>@(Model?.ProgramTitle ?? "0-2 YAŞ BEBEK BEZİ DESTEĞİ BAŞVURU FORMU")</h2>
            <img src="/thema/img/aile.jpg" alt="Bebek" style="width:90px;" />
        </div>

        <div class="card-body p-4">

            @* Sunucu tarafı doğrulama özetini, alan adlarını Türkçe etiketlerle göster *@
            @{
                var labels = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
                {
                    [nameof(Model.MotherNationalId)] = "Anne T.C. Kimlik No",
                    [nameof(Model.MotherBirthDate)] = "Anne Doğum Tarihi",
                    [nameof(Model.MotherFullName)] = "Anne Ad Soyad",
                    [nameof(Model.PhoneNumber)] = "Telefon",
                    [nameof(Model.BabyNationalId)] = "Bebek T.C. Kimlik No"
                };
                var allErrors = ViewData.ModelState
                .Where(kv => !string.IsNullOrEmpty(kv.Key) && kv.Value?.Errors?.Count > 0)
                .SelectMany(kv => kv.Value!.Errors.Select(e => new
                {
                    Key = kv.Key,
                    Label = labels.ContainsKey(kv.Key) ? labels[kv.Key] : kv.Key,
                    Message = e.ErrorMessage
                }))
                .ToList();
            }
            @if (allErrors.Any())
            {
                <div class="alert alert-danger" role="alert">
                    <div><strong>Lütfen formu kontrol ediniz:</strong></div>
                    <ul class="mb-0">
                        @foreach (var err in allErrors)
                        {
                            <li>@err.Label: @err.Message</li>
                        }
                    </ul>
                </div>
            }

            <form asp-action="Create" asp-controller="Applications" method="post" novalidate>
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="ProgramCode" />

                <div class="mb-3 row">
                    <label class="col-md-4 col-form-label fw-semibold req" asp-for="MotherNationalId"></label>
                    <div class="col-md-8">
                        <input class="form-control"
                               asp-for="MotherNationalId"
                               autocomplete="off" inputmode="numeric" maxlength="11"
                               aria-describedby="MotherNationalIdFeedback" />
                        <span id="MotherNationalIdFeedback"
                              class="invalid-feedback d-block text-danger"
                              asp-validation-for="MotherNationalId"></span>
                    </div>
                </div>

                <div class="mb-3 row">
                    <label class="col-md-4 col-form-label fw-semibold req" asp-for="MotherBirthDate"></label>
                    <div class="col-md-8">
                        <input class="form-control"
                               asp-for="MotherBirthDate"
                               type="date"
                               aria-describedby="MotherBirthDateFeedback" />
                        <span id="MotherBirthDateFeedback"
                              class="invalid-feedback d-block text-danger"
                              asp-validation-for="MotherBirthDate"></span>
                    </div>
                </div>

                <div class="mb-3 row">
                    <label class="col-md-4 col-form-label fw-semibold req" asp-for="MotherFullName"></label>
                    <div class="col-md-8">
                        <input class="form-control"
                               asp-for="MotherFullName"
                               maxlength="100"
                               aria-describedby="MotherFullNameFeedback" />
                        <span id="MotherFullNameFeedback"
                              class="invalid-feedback d-block text-danger"
                              asp-validation-for="MotherFullName"></span>
                    </div>
                </div>

                <div class="mb-3 row">
                    <label class="col-md-4 col-form-label fw-semibold req" asp-for="PhoneNumber"></label>
                    <div class="col-md-8">
                        <input class="form-control"
                               asp-for="PhoneNumber"
                               inputmode="tel" maxlength="11"
                               aria-describedby="PhoneNumberFeedback" />
                        <span id="PhoneNumberFeedback"
                              class="invalid-feedback d-block text-danger"
                              asp-validation-for="PhoneNumber"></span>
                    </div>
                </div>

                <div class="mb-3 row">
                    <label class="col-md-4 col-form-label fw-semibold req" asp-for="BabyNationalId"></label>
                    <div class="col-md-8">
                        <input class="form-control"
                               asp-for="BabyNationalId"
                               autocomplete="off" inputmode="numeric" maxlength="11"
                               aria-describedby="BabyNationalIdFeedback" />
                        <span id="BabyNationalIdFeedback"
                              class="invalid-feedback d-block text-danger"
                              asp-validation-for="BabyNationalId"></span>
                    </div>
                </div>

                <div class="text-center">
                    <button type="submit" class="btn btn-success">📤 Başvuru Yap</button>
                </div>
            </form>
        </div>

        <div class="card-footer text-center text-muted small">
            <strong>Battalgazi Belediyesi Bilgi İşlem Müdürlüğü</strong>
        </div>
    </div>
</div>

<!-- Açılışta bilgilendirme -->
<div class="modal fade" id="basvuruModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Battalgazi Belediyesi Bebek Bezi Desteği</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body" style="white-space: pre-line;">
                <strong>Müdürlük:</strong> SOSYAL YARDIM İŞLERİ ŞUBE MÜDÜRLÜĞÜ
                <strong>Projenin amacı:</strong> 2025 “Aile yılı” kapsamında bebek bezi desteği
                <strong>Proje başlangıcı:</strong> 01.06.2025
                <strong>Proje bitimi:</strong> 31.12.2025
                • TÜRKİYE CUMHURİYETİ vatandaşı olmak
                • Battalgazi ilçe sınırlarında ikamet ediyor olması
                • Bez desteği alacak çocukların 0 ile 24 ay arasında olması
                • Ailenin dar gelirli olması (dar gelirli: iki asgari ücretin altında olması gerekmektedir.)
                • Sosyal uyum yardımı alamayan aileler başvurabilir
                • Eksik ve sahte olduğu tespit edilen başvurular kabul edilmeyecektir
                • Başvurular bebeğin annesi üzerinden online olarak yapılacaktır

                <p style="color:red;font-weight:bold;text-align:center;font-size:1.2rem;">
                    NOT: BAŞVURULAR SADECE ONLINE SİSTEM ÜZERİNDEN KABUL EDİLMEKTEDİR.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Tamam</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Modal: her açılışta göster
        document.addEventListener("DOMContentLoaded", function () {
            const m = new bootstrap.Modal(document.getElementById('basvuruModal'), { backdrop: 'static' });
            m.show();
        });

        // Basit sayısal maskeleme
        function onlyDigits(v){ return (v||"").replace(/\D+/g,""); }
        document.addEventListener("input", function(e){
            if(e.target.id==="MotherNationalId" || e.target.id==="BabyNationalId"){
                e.target.value = onlyDigits(e.target.value).slice(0,11);
            }
            if(e.target.id==="PhoneNumber"){
                e.target.value = onlyDigits(e.target.value).slice(0,11);
            }
        });
    </script>
}
